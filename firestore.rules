rules_version = '2';

// Version 6.0: Consolidating public reads with recursive wildcards.
service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin']);
    }

    // --- Public Collections ---
    // Anyone can read, only admins can write.
    match /products/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /categories/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /sizes/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /colours/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /printOptions/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /wallTypes/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /thicknesses/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /materialTypes/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /finishTypes/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /adhesives/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /handles/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /shapes/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /heroSlides/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /trendingItems/{docId=**} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{docId=**} { allow read: if true; allow write: if isAdmin(); }

    // --- User Data ---
    // A user can get and update their own document.
    // Admins can perform any action on any user document.
    match /users/{userId} {
      allow get, update: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }
    
    // Users can read/write their own subcollections. Admins can read/write any user's subcollections.
    match /users/{userId}/{subcollection}/{docId=**} {
       allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
    }
  }
}
