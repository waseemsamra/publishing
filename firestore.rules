rules_version = '2';

// Version 7.0: Radically restructuring rules to break backend cache.
service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin']);
    }

    // --- User-specific Data ---
    // More specific rules for users must come before the general public rule.
    match /users/{userId}/{docId=**} {
       allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
    }
    match /users/{userId} {
      allow get, update: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // --- General Public Data Rule ---
    // This single rule covers all public collections by checking against a list.
    match /{collectionId}/{docId=**} {
      allow read: if collectionId in [
        'products', 'categories', 'sizes', 'colours', 'printOptions',
        'wallTypes', 'thicknesses', 'materialTypes', 'finishTypes',
        'adhesives', 'handles', 'shapes', 'heroSlides', 'trendingItems', 'settings',
        'lids', 'heroBoxes'
      ];
      allow write: if collectionId in [
        'products', 'categories', 'sizes', 'colours', 'printOptions',
        'wallTypes', 'thicknesses', 'materialTypes', 'finishTypes',
        'adhesives', 'handles', 'shapes', 'heroSlides', 'trendingItems', 'settings',
        'lids', 'heroBoxes'
      ] && isAdmin();
    }
  }
}

    
