rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin']);
    }

    // --- Explicit Public Collection Rules ---

    // Products
    match /products { allow list: if true; }
    match /products/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Categories
    match /categories { allow list: if true; }
    match /categories/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Sizes
    match /sizes { allow list: if true; }
    match /sizes/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Colours
    match /colours { allow list: if true; }
    match /colours/{docId} { allow get: if true; allow write: if isAdmin(); }

    // PrintOptions
    match /printOptions { allow list: if true; }
    match /printOptions/{docId} { allow get: if true; allow write: if isAdmin(); }

    // WallTypes
    match /wallTypes { allow list: if true; }
    match /wallTypes/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Thicknesses
    match /thicknesses { allow list: if true; }
    match /thicknesses/{docId} { allow get: if true; allow write: if isAdmin(); }

    // MaterialTypes
    match /materialTypes { allow list: if true; }
    match /materialTypes/{docId} { allow get: if true; allow write: if isAdmin(); }

    // FinishTypes
    match /finishTypes { allow list: if true; }
    match /finishTypes/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Adhesives
    match /adhesives { allow list: if true; }
    match /adhesives/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Handles
    match /handles { allow list: if true; }
    match /handles/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Shapes
    match /shapes { allow list: if true; }
    match /shapes/{docId} { allow get: if true; allow write: if isAdmin(); }

    // HeroSlides
    match /heroSlides { allow list: if true; }
    match /heroSlides/{docId} { allow get: if true; allow write: if isAdmin(); }

    // TrendingItems
    match /trendingItems { allow list: if true; }
    match /trendingItems/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Settings
    match /settings { allow list: if true; }
    match /settings/{docId} { allow get: if true; allow write: if isAdmin(); }

    // Rules for user-specific data.
    match /users/{userId} {
      // A user can get and update their own document.
      allow get, update: if request.auth != null && request.auth.uid == userId;
      // Admins can perform any action on any user document.
      allow read, write: if isAdmin();
    }
    
    // Rules for subcollections within a user's document (e.g., shopping cart, orders).
    match /users/{userId}/{subcollection}/{docId} {
       // A user can read and write to their own subcollections.
       // Admins can also read and write to any user's subcollections.
       allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
    }
  }
}
