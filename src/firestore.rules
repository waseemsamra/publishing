rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin']);
    }

    // Public Collections
    match /products/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /categories/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /sizes/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /colours/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /printOptions/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /wallTypes/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /thicknesses/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /materialTypes/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /finishTypes/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /adhesives/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /handles/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /shapes/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /heroSlides/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /trendingItems/{doc=**} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{doc=**} { allow read: if true; allow write: if isAdmin(); }

    // Rules for user-specific data.
    match /users/{userId} {
      // A user can get and update their own document.
      allow get, update: if request.auth != null && request.auth.uid == userId;
      // Admins can perform any action on any user document.
      allow read, write: if isAdmin();
    }
    
    // Rules for subcollections within a user's document (e.g., shopping cart, orders).
    match /users/{userId}/{subcollection}/{docId} {
       // A user can read and write to their own subcollections.
       // Admins can also read and write to any user's subcollections.
       allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
    }
  }
}
